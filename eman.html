<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المساعد الإيماني</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: The app is now a single-view dashboard, removing tabs for a more focused UX. The main screen integrates all key features: (1) A dynamic prayer time card suggesting Surahs. (2) A new daily plan for reading Surah Al-Baqarah, broken down by prayer times, with automatic highlighting of the current reading session. (3) A checklist for post-prayer Adhkar. (4) A dynamic Dua card that updates with each prayer. This integrated structure turns the app into a comprehensive daily guide. -->
    <!-- Visualization & Content Choices: Report Info: Adhkar, Baqarah plan, Prayer times, Duas. Goal: Consolidate all trackers into a single, interactive home screen. Viz/Presentation: (1) Baqarah Plan: An interactive HTML table with checkboxes and dynamic highlighting. (2) Adhkar: A simple HTML checklist. Interaction: State is managed via JS and persisted in localStorage. The UI dynamically updates based on the current prayer time. Justification: This unified design is more intuitive and task-oriented, directly addressing the user's workflow. Library/Method: Vanilla JS, Fetch API, Tailwind CSS. CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #FDFBF5;
            color: #4A4A4A;
        }
        .card {
            background-color: #FFFFFF;
            border: 1px solid #EAEAEA;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }
        .surah-text {
            font-family: 'Amiri', serif;
            font-size: 1.5rem;
            line-height: 2.5rem;
            text-align: center;
            direction: rtl;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .accordion-content.open {
            max-height: 1000px;
        }
        .accordion-button::after {
            content: '⊕';
            float: left;
            font-size: 1.5rem;
            transition: transform 0.3s;
        }
        .accordion-button.open::after {
            transform: rotate(45deg);
        }
        .adhkar-item input:checked + label {
            text-decoration: line-through;
            color: #a0aec0;
        }
        .baqarah-plan-row.highlight {
            background-color: #FDFBF5;
            border-right: 4px solid #8D9B6A;
        }
        .baqarah-plan-row td {
            padding: 0.75rem;
            vertical-align: middle;
        }
        .baqarah-plan-row input:checked + div span.font-bold {
            text-decoration: line-through;
            color: #a0aec0;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-[#4A5568]">المساعد الإيماني</h1>
            <p id="location" class="text-lg text-gray-600 mt-2">جاري تحديد الموقع...</p>
        </header>

        <main>
            <!-- Next Prayer Card -->
            <div id="next-prayer-card" class="card rounded-xl p-6 md:p-8">
                <div id="loading-state" class="text-center text-gray-500">
                    جاري مزامنة أوقات الصلاة...
                </div>
                <div id="prayer-content" class="hidden">
                     <div class="text-center">
                        <p class="text-lg text-gray-500 mb-2">الصلاة الحالية: <span id="current-prayer-name" class="font-bold"></span></p>
                        <h2 class="text-2xl md:text-3xl font-bold text-[#8D9B6A] mb-1">الصلاة القادمة: <span id="next-prayer-name"></span></h2>
                        <!-- <p class="text-xl text-gray-700">بعد <span id="time-to-next-prayer">--:--:--</span></p> -->
                    </div>
                    <div class="mt-6 space-y-4">
                        <div class="bg-gray-50 rounded-lg border">
                            <button id="accordion-btn-1" class="accordion-button w-full p-4 text-right">
                                <h3 class="text-xl font-bold">الركعة الأولى: <span id="rakah1-surah-name" class="text-[#4A5568]"></span></h3>
                            </button>
                            <div id="accordion-content-1" class="accordion-content px-4">
                                <div id="rakah1-details" class="py-4 border-t"></div>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg border">
                             <button id="accordion-btn-2" class="accordion-button w-full p-4 text-right">
                                <h3 class="text-xl font-bold">الركعة الثانية: <span id="rakah2-surah-name" class="text-[#4A5568]"></span></h3>
                            </button>
                            <div id="accordion-content-2" class="accordion-content px-4">
                               <div id="rakah2-details" class="py-4 border-t"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Baqarah Plan Card -->
            <div class="card rounded-xl p-6">
                <h2 class="text-2xl font-bold text-center mb-4">خطة ورد سورة البقرة اليومي</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-center">
                        <thead class="border-b">
                            <tr>
                                <th class="p-2">الصلاة</th>
                                <th class="p-2">قبل الصلاة</th>
                                <th class="p-2">بعد الصلاة</th>
                            </tr>
                        </thead>
                        <tbody id="baqarah-plan-body">
                            <!-- Rows will be generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Adhkar Card -->
            <div class="card rounded-xl p-6">
                <h2 class="text-2xl font-bold text-center mb-4">أذكار ما بعد الصلاة</h2>
                <div id="adhkar-tracker" class="space-y-3"></div>
                <div class="text-center mt-4">
                    <button id="reset-adhkar-btn" class="text-sm text-gray-500 hover:text-red-500">إعادة تعيين لليوم الجديد</button>
                </div>
            </div>

            <!-- Dua Card -->
            <div id="dua-card" class="card rounded-xl p-6 text-center">
                <h3 class="text-2xl font-bold text-[#8D9B6A] mb-4">دعاء الوقت</h3>
                <p id="dua-text" class="text-lg"></p>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA ---
        const surahData = {
            'الكافرون': { name: 'سورة الكافرون', text: 'قُلْ يَا أَيُّهَا الْكَافِرُونَ (1) لَا أَعْبُدُ مَا تَعْبُدُونَ (2) وَلَا أَنْتُمْ عَابِدُونَ مَا أَعْبُدُ (3) وَلَا أَنَا عَابِدٌ مَا عَبَدْتُمْ (4) وَلَا أَنْتُمْ عَابِدُونَ مَا أَعْبُدُ (5) لَكُمْ دِينُكُمْ وَلِيَ دِينِ (6)', info: 'مكية - 6 آيات', tafsir: 'إعلان البراءة من عبادة غير الله، وتأكيد على توحيد العبادة.', sabab_nuzul: 'نزلت رداً على كفار قريش عندما عرضوا على النبي أن يعبدوا إلهه سنة ويعبد هو آلهتهم سنة.' },
            'الإخلاص': { name: 'سورة الإخلاص', text: 'قُلْ هُوَ اللَّهُ أَحَدٌ (1) اللَّهُ الصَّمَدُ (2) لَمْ يَلِدْ وَلَمْ يُولَدْ (3) وَلَمْ يَكُنْ لَهُ كُفُوًا أَحَدٌ (4)', info: 'مكية - 4 آيات', tafsir: 'تصف وحدانية الله وتفرده بالكمال، وهي تعدل ثلث القرآن.', sabab_nuzul: 'نزلت رداً على المشركين الذين سألوا النبي أن يصف لهم ربه.' },
            'الأعلى': { name: 'سورة الأعلى', text: 'سَبِّحِ اسْمَ رَبِّكَ الْأَعْلَى (1) الَّذِي خَلَقَ فَسَوَّى (2) وَالَّذِي قَدَّرَ فَهَدَى (3) ...', info: 'مكية - 19 آية', tafsir: 'تنزيه لله ووصف لكمال قدرته، وتذكير بالصحف الأولى.', sabab_nuzul: 'لم يثبت سبب نزول خاص.' },
            'الغاشية': { name: 'سورة الغاشية', text: 'هَلْ أَتَاكَ حَدِيثُ الْغَاشِيَةِ...', info: 'مكية - 26 آية', tafsir: 'تصف أهوال يوم القيامة وأحوال أهل النار وأهل الجنة.', sabab_nuzul: 'لم يثبت سبب نزول خاص.' },
            'الضحى': { name: 'سورة الضحى', text: 'وَالضُّحَىٰ...', info: 'مكية - 11 آية', tafsir: 'تسلية للنبي ﷺ وتذكيره بنعم الله عليه، وتوجيهه لرعاية اليتيم والسائل والتحدث بنعمة ربه.', sabab_nuzul: 'نزلت بعد فترة انقطاع للوحي، فقال المشركون إن رب محمد قد تركه.' },
            'الشرح': { name: 'سورة الشرح', text: 'أَلَمْ نَشْرَحْ لَكَ صَدْرَكَ...', info: 'مكية - 8 آيات', tafsir: 'تذكير للنبي بنعم الله عليه من شرح الصدر ورفع الذكر، وتأكيد على أن مع العسر يسراً.', sabab_nuzul: 'تُعد تكملة لسورة الضحى في المعنى.' },
            'الفيل': { name: 'سورة الفيل', text: 'أَلَمْ تَرَ كَيْفَ فَعَلَ رَبُّكَ بِأَصْحَابِ الْفِيلِ...', info: 'مكية - 5 آيات', tafsir: 'تذكير بقصة أصحاب الفيل الذين حاولوا هدم الكعبة وكيف أهلكهم الله بطير أبابيل.', sabab_nuzul: 'نزلت تذكيراً بقدرة الله وحمايته لبيته الحرام.' },
            'قريش': { name: 'سورة قريش', text: 'لِإِيلَافِ قُرَيْشٍ...', info: 'مكية - 4 آيات', tafsir: 'تذكير لقبيلة قريش بنعم الله عليهم، وأهمها نعمة الأمن والطعام، ودعوتهم لعبادة رب هذا البيت.', sabab_nuzul: 'متصلة بسورة الفيل.' },
            'الشمس': { name: 'سورة الشمس', text: 'وَالشَّمْسِ وَضُحَاهَا...', info: 'مكية - 15 آية', tafsir: 'قسم بآيات كونية عظيمة على أن فلاح الإنسان في تزكية نفسه، وخسرانه في تدنيسها.', sabab_nuzul: 'لم يثبت سبب نزول خاص.' },
            'الليل': { name: 'سورة الليل', text: 'وَاللَّيْلِ إِذَا يَغْشَى...', info: 'مكية - 21 آية', tafsir: 'تبين اختلاف سعي الناس وأعمالهم، وتوضح أن الله ييسر أهل الخير للخير وأهل الشر للشر.', sabab_nuzul: 'نزلت في قصة رجلين أحدهما كريم والآخر بخيل.' },
            'البروج': { name: 'سورة البروج', text: 'وَالسَّمَاءِ ذَاتِ الْبُرُوجِ...', info: 'مكية - 22 آية', tafsir: 'تحكي قصة أصحاب الأخدود لتثبيت المؤمنين.', sabab_nuzul: 'لم يثبت سبب نزول خاص.' },
            'الطارق': { name: 'سورة الطارق', text: 'وَالسَّمَاءِ وَالطَّارِقِ...', info: 'مكية - 17 آية', tafsir: 'قسم من الله على أن كل نفس عليها حافظ من الملائكة.', sabab_nuzul: 'لم يثبت سبب نزول خاص.' },
            'الزلزلة': { name: 'سورة الزلزلة', text: 'إِذَا زُلْزِلَتِ الْأَرْضُ زِلْzَالَهَا...', info: 'مدنية - 8 آيات', tafsir: 'تصف زلزال يوم القيامة العظيم.', sabab_nuzul: 'لم يثبت سبب نزول خاص.' },
            'العاديات': { name: 'سورة العاديات', text: 'وَالْعَادِيَاتِ ضَبْحًا...', info: 'مكية - 11 آية', tafsir: 'يقسم الله بالخيل إشارةً إلى أن الإنسان بطبعه جاحد لنعم ربه.', sabab_nuzul: 'نزلت في سرية بعثها النبي ﷺ.' },
            'التين': { name: 'سورة التين', text: 'وَالتِّينِ وَالزَّيْتُونِ...', info: 'مكية - 8 آيات', tafsir: 'قسم بأماكن مقدسة على أن الله خلق الإنسان في أحسن تقويم.', sabab_nuzul: 'لم يثبت سبب نزول خاص.' },
            'العلق': { name: 'سورة العلق', text: 'اقْرَأْ بِاسْمِ رَبِّكَ الَّذِي خَلَقَ...', info: 'مكية - 19 آية', tafsir: 'أول ما نزل من القرآن، تأمر بالقراءة والعلم.', sabab_nuzul: 'أول 5 آيات نزلت في غار حراء.' },
            'المؤمنون (أولها)': { name: 'سورة المؤمنون (أولها)', text: 'قَدْ أَفْلَحَ الْمُؤْمِنُونَ...', info: 'مكية - 118 آية', tafsir: 'تصف صفات المؤمنين التي تؤدي بهم إلى الفلاح.', sabab_nuzul: 'لم يثبت سبب نزول خاص.' },
            'المؤمنون (تكملة)': { name: 'سورة المؤمنون (تكملة)', text: '...', info: 'مكية - 118 آية', tafsir: 'تكملة لصفات المؤمنين.', sabab_nuzul: 'لم يثبت سبب نزول خاص.' },
            'القدر': { name: 'سورة القدر', text: 'إِنَّا أَنْزَلْنَاهُ فِي لَيْلَةِ الْقَدْرِ...', info: 'مكية - 5 آيات', tafsir: 'تبيّن فضل ليلة القدر.', sabab_nuzul: 'لم يثبت سبب نزول خاص.' },
            'البينة': { name: 'سورة البينة', text: 'لَمْ يَكُنِ الَّذِينَ كَفَرُوا...', info: 'مدنية - 8 آيات', tafsir: 'توضح أن بعثة النبي محمد ﷺ كانت حجة واضحة.', sabab_nuzul: 'لم يثبت سبب نزول خاص.' },
            'الفلق': { name: 'سورة الفلق', text: 'قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ...', info: 'مكية - 5 آيات', tafsir: 'تعليم للمسلمين أن يستعيذوا بالله من الشرور.', sabab_nuzul: 'نزلت مع سورة الناس عندما سُحر النبي ﷺ.' },
            'الناس': { name: 'سورة الناس', text: 'قُلْ أَعُوذُ بِرَبِّ النَّاسِ...', info: 'مكية - 6 آيات', tafsir: 'تعليم للمسلمين أن يستعيذوا بالله من شر الوسواس.', sabab_nuzul: 'نزلت مع سورة الفلق.' },
            'التكوير': { name: 'سورة التكوير', text: 'إِذَا الشَّمْسُ كُوِّرَتْ...', info: 'مكية - 29 آية', tafsir: 'تصف أهوال يوم القيامة.', sabab_nuzul: 'لم يثبت سبب نزول خاص.'},
            'الانفطار': { name: 'سورة الانفطار', text: 'إِذَا السَّمَاءُ انْفَطَرَتْ...', info: 'مكية - 19 آية', tafsir: 'تكمل وصف أهوال يوم القيامة.', sabab_nuzul: 'لم يثبت سبب نزول خاص.'},
            'القارعة': { name: 'سورة القارعة', text: 'الْقَارِعَةُ...', info: 'مكية - 11 آية', tafsir: 'تصف أهوال يوم القيامة الذي يقرع القلوب.', sabab_nuzul: 'لم يثبت سبب نزول خاص.'},
            'العصر': { name: 'سورة العصر', text: 'وَالْعَصْرِ...', info: 'مكية - 3 آيات', tafsir: 'يقسم الله بالزمن أن كل إنسان في خسران إلا من استثنى.', sabab_nuzul: 'لم يثبت سبب نزول خاص.'},
            'الهمزة': { name: 'سورة الهمزة', text: 'وَيْلٌ لِكُلِّ هُمَزَةٍ لُمَزَةٍ...', info: 'مكية - 9 آيات', tafsir: 'وعيد شديد لمن يعيب الناس ويغتابهم.', sabab_nuzul: 'نزلت في بعض كفار قريش.'},
            'الماعون': { name: 'سورة الماعون', text: 'أَرَأَيْتَ الَّذِي يُكَذِّبُ بِالدِّينِ...', info: 'مكية - 7 آيات', tafsir: 'تصف الذي يكذب بيوم الدين.', sabab_nuzul: 'نزلت في بعض كفار قريش.' },
            'النصر': { name: 'سورة النصر', text: 'إِذَا جَاءَ نَصْرُ اللَّهِ وَالْفَتْحُ...', info: 'مدنية - 3 آيات', tafsir: 'بشارة للنبي ﷺ بنصر الله وفتح مكة.', sabab_nuzul: 'من أواخر ما نزل.' },
            'المسد': { name: 'سورة المسد', text: 'تَبَّتْ يَدَا أَبِي لَهَبٍ وَتَبَّ...', info: 'مكية - 5 آيات', tafsir: 'وعيد شديد لأبي لهب وزوجته.', sabab_nuzul: 'نزلت عندما جمع النبي ﷺ قريشاً لدعوتهم.' },
            'السجدة': { name: 'سورة السجدة', text: 'الم...', info: 'مكية - 30 آية', tafsir: 'تؤكد صدق القرآن، وتصف دلائل قدرة الله.', sabab_nuzul: 'لم يثبت سبب نزول خاص.' },
            'الإنسان': { name: 'سورة الإنسان', text: 'هَلْ أَتَىٰ عَلَى الْإِنْسَانِ...', info: 'مدنية - 31 آية', tafsir: 'تصف خلق الإنسان وتكريمه، ونعيم الأبرار.', sabab_nuzul: 'لم يثبت سبب نزول خاص.' },
            'الجمعة': { name: 'سورة الجمعة', text: 'يُسَبِّحُ لِلَّهِ مَا فِي السَّمَاوَاتِ...', info: 'مدنية - 11 آية', tafsir: 'تتحدث عن فضل الله ببعثة النبي.', sabab_nuzul: 'نزلت آياتها الأخيرة عندما انشغل بعض الصحابة عن خطبة الجمعة.' },
            'المنافقون': { name: 'سورة المنافقون', text: 'إِذَا جَاءَكَ الْمُنَافِقُونَ...', info: 'مدنية - 11 آية', tafsir: 'تفضح صفات المنافقين وكذبهم.', sabab_nuzul: 'نزلت بعد غزوة بني المصطلق.' }
        };

        const schedule = {
            'الأحد': { 'الفجر': { surah1: 'الكافرون', surah2: 'الإخلاص' }, 'الظهر': { surah1: 'الأعلى', surah2: 'الغاشية' }, 'العصر': { surah1: 'الضحى', surah2: 'الشرح' }, 'المغرب': { surah1: 'الفيل', surah2: 'قريش' }, 'العشاء': { surah1: 'الشمس', surah2: 'الليل' } },
            'الاثنين': { 'الفجر': { surah1: 'الأعلى', surah2: 'الغاشية' }, 'الظهر': { surah1: 'البروج', surah2: 'الطارق' }, 'العصر': { surah1: 'الزلزلة', surah2: 'العاديات' }, 'المغرب': { surah1: 'الكافرون', surah2: 'الإخلاص' }, 'العشاء': { surah1: 'التين', surah2: 'العلق' } },
            'الثلاثاء': { 'الفجر': { surah1: 'المؤمنون (أولها)', surah2: 'المؤمنون (تكملة)' }, 'الظهر': { surah1: 'الليل', surah2: 'الضحى' }, 'العصر': { surah1: 'القدر', surah2: 'البينة' }, 'المغرب': { surah1: 'الفلق', surah2: 'الناس' }, 'العشاء': { surah1: 'الأعلى', surah2: 'الغاشية' } },
            'الأربعاء': { 'الفجر': { surah1: 'التكوير', surah2: 'الانفطار' }, 'الظهر': { surah1: 'الطارق', surah2: 'الأعلى' }, 'العصر': { surah1: 'العاديات', surah2: 'القارعة' }, 'المغرب': { surah1: 'العصر', surah2: 'الهمزة' }, 'العشاء': { surah1: 'الشمس', surah2: 'الليل' } },
            'الخميس': { 'الفجر': { surah1: 'الكافرون', surah2: 'الإخلاص' }, 'الظهر': { surah1: 'الشرح', surah2: 'التين' }, 'العصر': { surah1: 'قريش', surah2: 'الماعون' }, 'المغرب': { surah1: 'النصر', surah2: 'المسد' }, 'العشاء': { surah1: 'البروج', surah2: 'الطارق' } },
            'الجمعة': { 'الفجر': { surah1: 'السجدة', surah2: 'الإنسان' }, 'الظهر': { surah1: 'الجمعة', surah2: 'المنافقون' }, 'العصر': { surah1: 'الأعلى', surah2: 'الغاشية' }, 'المغرب': { surah1: 'الكافرون', surah2: 'الإخلاص' }, 'العشاء': { surah1: 'التكوير', surah2: 'الانفطار' } },
            'السبت': { 'الفجر': { surah1: 'الأعلى', surah2: 'الغاشية' }, 'الظهر': { surah1: 'الشمس', surah2: 'الليل' }, 'العصر': { surah1: 'الضحى', surah2: 'الشرح' }, 'المغرب': { surah1: 'الفلق', surah2: 'الناس' }, 'العشاء': { surah1: 'البروج', surah2: 'الطارق' } }
        };

        const postPrayerAdhkar = [
            { id: 'astaghfirullah', text: 'أستغفر الله (3 مرات)' },
            { id: 'allahumma_anta_salam', text: 'اللهم أنت السلام ومنك السلام...' },
            { id: 'subhanallah', text: 'سبحان الله (33 مرة)' },
            { id: 'alhamdulillah', text: 'الحمد لله (33 مرة)' },
            { id: 'allahuakbar', text: 'الله أكبر (33 مرة)' },
            { id: 'la_ilaha_illa_allah', text: 'لا إله إلا الله وحده لا شريك له...' },
            { id: 'ayat_kursi', text: 'آية الكرسي' },
        ];

        const duaList = {
            Fajr: "اللهم إني أسألك علماً نافعاً، ورزقاً طيباً، وعملاً متقبلاً.",
            Dhuhr: "اللهم أصلح لي ديني الذي هو عصمة أمري، وأصلح لي دنياي التي فيها معاشي.",
            Asr: "اللهم إني أعوذ بك من العجز والكسل، والجبن والهرم والبخل.",
            Maghrib: "ربنا آتنا في الدنيا حسنة وفي الآخرة حسنة وقنا عذاب النار.",
            Isha: "اللهم يا مقلب القلوب ثبت قلبي على دينك."
        };

        const baqarahPlan = {
            Fajr: { before: { verses: '1-29', topic: 'أصناف الناس ومثلهم' }, after: { verses: '30-57', topic: 'خلق آدم وقصة بني إسرائيل' } },
            Dhuhr: { before: { verses: '58-86', topic: 'عصيان بني إسرائيل ونقضهم للمواثيق' }, after: { verses: '87-112', topic: 'جدال بني إسرائيل مع الأنبياء' } },
            Asr: { before: { verses: '113-141', topic: 'ملة إبراهيم عليه السلام' }, after: { verses: '142-167', topic: 'تحويل القبلة وأحكامها' } },
            Maghrib: { before: { verses: '168-203', topic: 'أحكام الطعام والقصاص والصيام والحج' }, after: { verses: '204-242', topic: 'أحكام القتال والإنفاق والأسرة' } },
            Isha: { before: { verses: '243-260', topic: 'قصة طالوت وآيات إحياء الموتى' }, after: { verses: '261-286', topic: 'فضل الصدقة وخطر الربا وخواتيم السورة' } }
        };
        const prayerNamesAr = {'Fajr': 'الفجر', 'Dhuhr': 'الظهر', 'Asr': 'العصر', 'Maghrib': 'المغرب', 'Isha': 'العشاء'};

        let prayerTimesData = null;
        let countdownInterval = null;

        // --- UI ELEMENTS ---
        const locationEl = document.getElementById('location');
        const loadingStateEl = document.getElementById('loading-state');
        const prayerContentEl = document.getElementById('prayer-content');
        const currentPrayerNameEl = document.getElementById('current-prayer-name');
        const nextPrayerNameEl = document.getElementById('next-prayer-name');
        const timeToNextPrayerEl = document.getElementById('time-to-next-prayer');
        const duaTextEl = document.getElementById('dua-text');
        const adhkarTrackerEl = document.getElementById('adhkar-tracker');
        const baqarahPlanBodyEl = document.getElementById('baqarah-plan-body');

        // --- LOCAL STORAGE & STATE ---
        let adhkarState = JSON.parse(localStorage.getItem('adhkarState_v2')) || {};
        let baqarahState = JSON.parse(localStorage.getItem('baqarahState_v2')) || {};
        
        const lastVisit = localStorage.getItem('lastVisit');
        const today = new Date().toDateString();
        if (lastVisit !== today) {
            localStorage.setItem('adhkarState_v2', JSON.stringify({}));
            adhkarState = {};
            localStorage.setItem('baqarahState_v2', JSON.stringify({}));
            baqarahState = {};
            localStorage.setItem('lastVisit', today);
        }

        // --- RENDER FUNCTIONS ---
        function renderAdhkar() {
            adhkarTrackerEl.innerHTML = '';
            postPrayerAdhkar.forEach(adhkar => {
                const isChecked = adhkarState[adhkar.id] || false;
                const item = document.createElement('div');
                item.className = 'adhkar-item flex items-center bg-gray-50 p-3 rounded-lg';
                item.innerHTML = `
                    <input type="checkbox" id="${adhkar.id}" class="ml-3 h-5 w-5 accent-[#8D9B6A]" ${isChecked ? 'checked' : ''}>
                    <label for="${adhkar.id}" class="text-lg">${adhkar.text}</label>
                `;
                item.querySelector('input').addEventListener('change', (e) => {
                    adhkarState[e.target.id] = e.target.checked;
                    localStorage.setItem('adhkarState_v2', JSON.stringify(adhkarState));
                });
                adhkarTrackerEl.appendChild(item);
            });
        }

        function renderBaqarahPlan() {
            baqarahPlanBodyEl.innerHTML = '';
            for (const prayer in baqarahPlan) {
                const prayerName = prayerNamesAr[prayer];
                const plan = baqarahPlan[prayer];
                const beforeId = `${prayer}-before`;
                const afterId = `${prayer}-after`;
                const isBeforeChecked = baqarahState[beforeId] || false;
                const isAfterChecked = baqarahState[afterId] || false;

                const row = document.createElement('tr');
                row.id = `plan-row-${prayer}`;
                row.className = 'baqarah-plan-row border-b';
                row.innerHTML = `
                    <td class="font-bold">${prayerName}</td>
                    <td>
                        <label class="flex items-center justify-center cursor-pointer p-2">
                            <input type="checkbox" id="${beforeId}" class="ml-3 h-4 w-4 accent-[#8D9B6A]" ${isBeforeChecked ? 'checked' : ''}>
                            <div>
                                <span class="font-bold">آيات ${plan.before.verses}</span>
                                <span class="text-xs text-gray-500 block">${plan.before.topic}</span>
                            </div>
                        </label>
                    </td>
                    <td>
                        <label class="flex items-center justify-center cursor-pointer p-2">
                            <input type="checkbox" id="${afterId}" class="ml-3 h-4 w-4 accent-[#8D9B6A]" ${isAfterChecked ? 'checked' : ''}>
                             <div>
                                <span class="font-bold">آيات ${plan.after.verses}</span>
                                <span class="text-xs text-gray-500 block">${plan.after.topic}</span>
                            </div>
                        </label>
                    </td>
                `;
                baqarahPlanBodyEl.appendChild(row);
            }
            baqarahPlanBodyEl.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    baqarahState[e.target.id] = e.target.checked;
                    localStorage.setItem('baqarahState_v2', JSON.stringify(baqarahState));
                });
            });
        }

        function highlightCurrentBaqarahSession(currentPrayerKey, nextPrayerKey) {
            document.querySelectorAll('.baqarah-plan-row').forEach(r => r.classList.remove('highlight'));
            const now = new Date();
            const prayerTimeStr = prayerTimesData[currentPrayerKey].split(' ')[0];
            const prayerTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), ...prayerTimeStr.split(':'));
            
            const timeSincePrayer = now - prayerTime;
            if (timeSincePrayer >= 0 && timeSincePrayer < 30 * 60 * 1000) { 
                 document.getElementById(`plan-row-${currentPrayerKey}`).classList.add('highlight');
            } else {
                 document.getElementById(`plan-row-${nextPrayerKey}`).classList.add('highlight');
            }
        }
        
        // --- CORE LOGIC ---
        function getPrayerTimes(latitude, longitude) {
            const date = new Date();
            const url = `https://api.aladhan.com/v1/calendar/${date.getFullYear()}/${date.getMonth() + 1}?latitude=${latitude}&longitude=${longitude}&method=4`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const todayData = data.data[date.getDate() - 1];
                    prayerTimesData = todayData.timings;
                    loadingStateEl.classList.add('hidden');
                    prayerContentEl.classList.remove('hidden');
                    startCountdown();
                })
                .catch(error => {
                    loadingStateEl.textContent = 'فشل في جلب أوقات الصلاة. يرجى المحاولة مرة أخرى.';
                });
        }
        
        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

            countdownInterval = setInterval(() => {
                const now = new Date();
                let nextPrayerKey = null;
                let nextPrayerTime = null;
                let currentPrayerKey = "Isha";

                for (const prayer of prayerOrder) {
                    const prayerTimeStr = prayerTimesData[prayer].split(' ')[0];
                    const prayerTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), ...prayerTimeStr.split(':'));
                    if (prayerTime > now) {
                        nextPrayerKey = prayer;
                        nextPrayerTime = prayerTime;
                        break;
                    }
                    currentPrayerKey = prayer;
                }

                if (!nextPrayerKey) {
                    const tomorrow = new Date(now);
                    tomorrow.setDate(now.getDate() + 1);
                    const fajrTimeStr = prayerTimesData['Fajr'].split(' ')[0];
                    nextPrayerKey = 'Fajr';
                    nextPrayerTime = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), ...fajrTimeStr.split(':'));
                }

                const diff = nextPrayerTime - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                currentPrayerNameEl.textContent = prayerNamesAr[currentPrayerKey];
                nextPrayerNameEl.textContent = prayerNamesAr[nextPrayerKey];
                
                const timeToNextPrayerEl = document.getElementById('time-to-next-prayer');
                if (timeToNextPrayerEl) {
                    timeToNextPrayerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
                
                updateSurahSuggestion(currentPrayerKey);
                duaTextEl.textContent = duaList[currentPrayerKey];
                highlightCurrentBaqarahSession(currentPrayerKey, nextPrayerKey);

            }, 1000);
        }

        function updateSurahSuggestion(currentPrayerKey) {
            const dayIndex = new Date().getDay();
            const dayName = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'][dayIndex];
            const prayerName = prayerNamesAr[currentPrayerKey];
            const surahs = schedule[dayName][prayerName];
            if (!surahs) return;

            const surah1Info = surahData[surahs.surah1];
            const surah2Info = surahData[surahs.surah2];
            
            document.getElementById('rakah1-surah-name').textContent = surah1Info.name;
            document.getElementById('rakah2-surah-name').textContent = surah2Info.name;
            document.getElementById('rakah1-details').innerHTML = createDetailHTML(surah1Info);
            document.getElementById('rakah2-details').innerHTML = createDetailHTML(surah2Info);
        }
        
        function createDetailHTML(detail) {
            if (!detail) return '<p>لا توجد بيانات لهذه السورة.</p>';
            return `
                <div class="space-y-4 text-right">
                    <div><h4 class="font-bold text-lg text-[#8D9B6A]">نص السورة:</h4><div class="surah-text bg-gray-100 p-4 rounded-md mt-2">${detail.text}</div></div>
                    <div><h4 class="font-bold text-lg text-[#8D9B6A]">معلومات:</h4><p>${detail.info}</p></div>
                    <div><h4 class="font-bold text-lg text-[#8D9B6A]">تفسير ميسر:</h4><p>${detail.tafsir}</p></div>
                    <div><h4 class="font-bold text-lg text-[#8D9B6A]">سبب النزول:</h4><p>${detail.sabab_nuzul}</p></div>
                </div>
            `;
        }
        
        document.getElementById('reset-adhkar-btn').addEventListener('click', () => {
            localStorage.setItem('adhkarState_v2', JSON.stringify({}));
            adhkarState = {};
            renderAdhkar();
        });

        // Accordion
        const accordions = [
            { btn: document.getElementById('accordion-btn-1'), content: document.getElementById('accordion-content-1') },
            { btn: document.getElementById('accordion-btn-2'), content: document.getElementById('accordion-content-2') }
        ];
        accordions.forEach(acc => {
            acc.btn.addEventListener('click', () => {
                const isOpen = acc.content.classList.contains('open');
                accordions.forEach(otherAcc => {
                    otherAcc.content.classList.remove('open');
                    otherAcc.btn.classList.remove('open');
                });
                if (!isOpen) {
                    acc.content.classList.add('open');
                    acc.btn.classList.add('open');
                }
            });
        });

        function init() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=ar`)
                            .then(res => res.json())
                            .then(data => {
                                locationEl.textContent = `الموقع الحالي: ${data.city}, ${data.countryName}`;
                            });
                        getPrayerTimes(latitude, longitude);
                    },
                    () => {
                        locationEl.textContent = 'تعذر الوصول للموقع. سيتم استخدام أوقات مكة المكرمة.';
                        getPrayerTimes(21.4225, 39.8262);
                    }
                );
            } else {
                locationEl.textContent = 'الموقع الجغرافي غير مدعوم. سيتم استخدام أوقات مكة المكرمة.';
                getPrayerTimes(21.4225, 39.8262);
            }

            renderAdhkar();
            renderBaqarahPlan();
        }

        init();
    });
    </script>
</body>
</html>
